<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Real world distance using point projection</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #results,
      #clickedPoints,
      #worldResults {
        white-space: pre;
        margin-top: 20px;
      }
      canvas {
        border: 1px solid black;
        margin-top: 10px;
        display: block;
        max-width: 100%;
      }
      fieldset {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ccc;
      }
      fieldset[disabled] {
        opacity: 0.5;
      }
      .imageResult {
        margin-top: 20px;
        padding: 10px;
        border: 1px dashed #666;
      }
    </style>
  </head>
  <body>
    <h1>Real world distance using Perspective Projection</h1>

    <!-- Step 1: Calibration -->
    <fieldset id="step1">
      <legend>
        <h2>Step 1: Upload chessboard(9 x 7) images to calibrate camera</h2>
      </legend>
      <form id="calibrationForm" enctype="multipart/form-data">
        <label for="calibrationImages">Choose calibration images:</label>
        <input type="file" id="calibrationImages" name="images" multiple />
        <button type="submit">Calibrate</button>
      </form>
      <h3>Calibration values</h3>
      <div id="results"></div>
    </fieldset>

    <!-- Step 2: Distance -->
    <fieldset id="step2" disabled>
      <legend><h2>Step 2: Enter / Update distance</h2></legend>
      <form id="distanceForm">
        <label for="distanceInput"
          >Distance between camera and object (cm):</label
        >
        <input
          type="number"
          id="distanceInput"
          name="distance"
          min="1"
          required
        />
        <button type="submit">Save Distance</button>
      </form>
      <div id="currentDistance"></div>
    </fieldset>

    <!-- Step 3: Click Points (repeatable) -->
    <fieldset id="step3" disabled>
      <legend>
        <h2>Step 3: Upload an image and click 4 points in clockwise fashion</h2>
      </legend>
      <label for="pointImage">Choose an image:</label>
      <input type="file" id="pointImage" name="pointImage" />
      <canvas id="imageCanvas"></canvas>
      <h3>Clicked Points (max 4)</h3>
      <div id="clickedPoints"></div>
    </fieldset>

    <!-- Step 4: Results -->
    <fieldset id="step4" disabled>
      <legend><h2>Step 4: Results</h2></legend>
      <div id="worldResults"></div>
    </fieldset>

    <script>
      let calibrationData = {}; // Fx, Fy, Ox, Oy
      let clickedPoints = []; // Points for current image
      let distance = null; // Current distance value
      let imageCounter = 0; // Track how many images processed

      // Step 1: Calibration
      document
        .getElementById("calibrationForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const res = await fetch("/calibrate", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          if (data.error) {
            document.getElementById("results").textContent =
              "Error: " + data.error;
            return;
          }

          calibrationData = data;
          document.getElementById(
            "results"
          ).textContent = `Fx = ${data.Fx}\nFy = ${data.Fy}\nOx = ${data.Ox}\nOy = ${data.Oy}`;

          document.getElementById("step2").disabled = false;
        });

      // Step 2: Enter / Update distance
      document
        .getElementById("distanceForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          distance = document.getElementById("distanceInput").value;
          if (distance && distance > 0) {
            document.getElementById(
              "currentDistance"
            ).textContent = `Current Distance: ${distance} cm`;
            document.getElementById("step3").disabled = false;
          }
        });

      // Step 3: Upload image + click 4 points
      const canvas = document.getElementById("imageCanvas");
      const ctx = canvas.getContext("2d");
      const clickedPointsDiv = document.getElementById("clickedPoints");

      document.getElementById("pointImage").addEventListener("change", (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function (event) {
          const img = new Image();
          img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            clickedPoints = [];
            clickedPointsDiv.textContent = "";
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      canvas.addEventListener("click", (e) => {
        if (clickedPoints.length >= 4) {
          alert(
            "You have already selected 4 points for this image. Upload a new image to continue."
          );
          return;
        }

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        clickedPoints.push({ x: Math.round(x), y: Math.round(y) });

        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();

        clickedPointsDiv.textContent = clickedPoints
          .map((p, i) => `Point ${i + 1}: (${p.x}, ${p.y})`)
          .join("\n");

        if (clickedPoints.length === 4) {
          processImageResults();
        }
      });

      // Step 4: Compute and append results for current image
      function processImageResults() {
        imageCounter++;

        const dx12 = Math.sqrt(
          Math.pow(clickedPoints[0].x - clickedPoints[1].x, 2) +
            Math.pow(clickedPoints[0].y - clickedPoints[1].y, 2)
        );
        const dx23 = Math.sqrt(
          Math.pow(clickedPoints[1].x - clickedPoints[2].x, 2) +
            Math.pow(clickedPoints[1].y - clickedPoints[2].y, 2)
        );

        const Fx = parseFloat(calibrationData.Fx);
        const Fy = parseFloat(calibrationData.Fy);
        const dist = parseFloat(distance);

        const X_world = (dx12 * dist) / Fx;
        const Y_world = (dx23 * dist) / Fy;

        const resultsDiv = document.getElementById("worldResults");
        const block = document.createElement("div");
        block.className = "imageResult";
        block.textContent =
          `Image ${imageCounter}:\n` +
          `Distance (cm): ${dist}\n` +
          `Point 1 = (${clickedPoints[0].x}, ${clickedPoints[0].y})\n` +
          `Point 2 = (${clickedPoints[1].x}, ${clickedPoints[1].y})\n` +
          `Point 3 = (${clickedPoints[2].x}, ${clickedPoints[2].y})\n` +
          `Point 4 = (${clickedPoints[3].x}, ${clickedPoints[3].y})\n` +
          `X_world = ${X_world.toFixed(3)}cm\n` +
          `Y_world = ${Y_world.toFixed(3)}cm\n`;

        resultsDiv.appendChild(block);

        document.getElementById("step4").disabled = false;
      }
    </script>
  </body>
</html>
